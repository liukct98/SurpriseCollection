<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Home</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
</head>
<body>
  <header>Benvenuto,  <span id="user-name">...</span></header>
  <div class="container">
    <h1>La tua collezione</h1>
    <div class="home-buttons">
      <button onclick="location.href='add.html'" class="btn-main">➕ Aggiungi Serie</button>
      <button onclick="location.href='collection.html'" class="btn-main">📦 Visualizza Collezione</button>
      <button onclick="location.href='stats.html'" class="btn-main">📊 Statistiche</button>
      <button onclick="location.href='wishlist.html'" class="btn-main">💝 Lista Desideri</button>
      <button id="logout-btn" class="btn-main">🔓 Logout</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <a href="home.html" class="nav-item active">
      <span class="icon">🏠</span>
      <span class="label">Home</span>
      <span class="ripple"></span>
    </a>
    <a href="add.html" class="nav-item">
      <span class="icon">➕</span>
      <span class="label">Aggiungi</span>
      <span class="ripple"></span>
    </a>
    <a href="collection.html" class="nav-item">
      <span class="icon">📦</span>
      <span class="label">Collezione</span>
      <span class="ripple"></span>
    </a>
    <a href="stats.html" class="nav-item">
      <span class="icon">📊</span>
      <span class="label">Statistiche</span>
      <span class="ripple"></span>
    </a>
    <a href="wishlist.html" class="nav-item">
      <span class="icon">💝</span>
      <span class="label">Wishlist</span>
      <span class="ripple"></span>
    </a>
  </nav>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // =============================
    // Inizializzazione Supabase
    // =============================
    const supabaseUrl = "https://ksypexyadycktzbfllfd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzeXBleHlhZHlja3R6YmZsbGZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTYyMzEsImV4cCI6MjA3MjQ5MjIzMX0.INevNjooRZeLB--TM24JuIsq9EA47Zk3gBpIqjFyNGE";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Logout
    document.getElementById('logout-btn').addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut();
      if (!error) location.href = 'index.html';
      else alert("Errore logout: " + error.message);
    });

    // Mostra username utente loggato
    async function showUserName() {
      const { data, error } = await supabase.auth.getUser();
      if (error) {
        console.error(error);
        return;
      }
      if (data.user) {
        try {
          // Cerca lo username nella tabella users
          const { data: userProfile, error: profileError } = await supabase
            .from('users')
            .select('username')
            .eq('mail', data.user.email)
            .single();
          
          if (userProfile && userProfile.username) {
            document.getElementById('user-name').textContent = userProfile.username;
          } else {
            // Fallback all'email se non trova lo username
            document.getElementById('user-name').textContent = data.user.email;
          }
        } catch (err) {
          // Fallback all'email in caso di errore
          document.getElementById('user-name').textContent = data.user.email;
        }
      }
    }
    showUserName();
    
    // =============================
    // PWA Install Prompt
    // =============================
    let deferredPrompt;
    let installButton;

    // Controlla se l'app è già installata
    if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
      console.log('App già installata');
    } else {
      // Crea il bottone di installazione
      createInstallButton();
    }

    function createInstallButton() {
      installButton = document.createElement('button');
      installButton.textContent = '📱 Installa App';
      installButton.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        transition: transform 0.3s ease;
      `;
      
      installButton.addEventListener('click', async () => {
        if (deferredPrompt) {
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          console.log('Install prompt result:', outcome);
          deferredPrompt = null;
        } else {
          // Fallback per browser che non supportano il prompt automatico
          alert('Per installare l\'app:\n\niOS: Tocca il pulsante Condividi e seleziona "Aggiungi alla schermata Home"\n\nAndroid: Apri il menu del browser e seleziona "Installa app" o "Aggiungi alla schermata Home"');
        }
        installButton.style.display = 'none';
      });
      
      document.body.appendChild(installButton);
    }

    // Event listener per il prompt di installazione nativo
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      console.log('Install prompt available');
    });

    // Nasconde il bottone se l'app viene installata
    window.addEventListener('appinstalled', (evt) => {
      console.log('App installata con successo');
      if (installButton) installButton.style.display = 'none';
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
        .then(reg => console.log('Service Worker registrato', reg))
        .catch(err => console.error('Errore Service Worker', err));
        });
    }
  </script>
</body>
</html>
