<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta n            statusDiv.inner          statusDiv.innerHTML = `
            <h1>‚úÖ Account confermato!</h1>
            <p>Il tuo account √® stato confermato con successo.</p>
            <p>Ora puoi effettuare il login con le tue credenziali.</p>
            <button onclick="location.href='index.html'" class="btn-primary">üîê Vai al Login</button>
          `             <h1>‚úÖ Account confermato!</h1>
              <p>Il tuo account √® stato confermato con successo.</p>
              <p>Ora puoi effettuare il login con le tue credenziali.</p>
              <button onclick="location.href='index.html'" class="btn-primary">üîê Vai al Login</button>
            `rt" content="width=device-width, initial-scale=1.0">
  <title>Conferma Account - Catalogo Collezioni</title>
  <link rel="stylesheet" href="style.css">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FF6B35">
  
  <!-- Apple PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Sorpresine">
  <link rel="apple-touch-icon" href="icon-180.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="icon-152.png">
  <link rel="apple-touch-icon" sizes="120x120" href="icon-120.png">
</head>
<body>
  <header>Catalogo Collezioni</header>
  <div class="container">
    <div class="auth-container">
      <div id="confirmation-status">
        <div class="spinner"></div>
        <h1>üîÑ Conferma in corso...</h1>
        <p>Stiamo verificando il tuo account...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.skypack.dev/@supabase/supabase-js@2'
    
    const supabaseUrl = 'https://ksypexyadycktzbfllfd.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzeXBleHlhZHlja3R6YmZsbGZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTYyMzEsImV4cCI6MjA3MjQ5MjIzMX0.INevNjooRZeLB--TM24JuIsq9EA47Zk3gBpIqjFyNGE'
    const supabase = createClient(supabaseUrl, supabaseKey)

    async function handleEmailConfirmation() {
      const statusDiv = document.getElementById('confirmation-status')
      
      try {
        // Controlla se ci sono parametri di autenticazione nell'URL
        const urlParams = new URLSearchParams(window.location.search)
        const hashParams = new URLSearchParams(window.location.hash.substring(1))
        
        // Ottieni i token dalla hash o dalla query string
        const accessToken = hashParams.get('access_token') || urlParams.get('access_token')
        const refreshToken = hashParams.get('refresh_token') || urlParams.get('refresh_token')
        const type = hashParams.get('type') || urlParams.get('type')
        const token = urlParams.get('token') || hashParams.get('token')
        
        console.log('URL completo:', window.location.href)
        console.log('Access token:', accessToken)
        console.log('Type:', type)
        console.log('Token:', token)
        
        if (accessToken && (type === 'signup' || type === 'email' || type === 'confirmation')) {
          // Imposta la sessione con i token ricevuti
          const { data, error } = await supabase.auth.setSession({
            access_token: accessToken,
            refresh_token: refreshToken
          })
          
          if (error) {
            console.error('Errore durante la conferma:', error)
            statusDiv.innerHTML = `
              <h1>‚ùå Errore di conferma</h1>
              <p>Si √® verificato un errore durante la conferma dell'account.</p>
              <p class="error-detail">${error.message}</p>
              <button onclick="location.href='index.html'" class="btn-primary">üîô Torna al Login</button>
            `
          } else {
            console.log('Conferma riuscita:', data)
            statusDiv.innerHTML = `
              <h1>‚úÖ Account confermato!</h1>
              <p>Il tuo account √® stato confermato con successo.</p>
              <p>Ora puoi effettuare il login con le tue credenziali.</p>
              <button onclick="location.href='index.html'" class="btn-primary">ÔøΩ Vai al Login</button>
            `
            
            // Reindirizza automaticamente dopo 3 secondi
            setTimeout(() => {
              window.location.href = 'index.html'
            }, 3000)
          }
        } else if (accessToken || token) {
          // Altri tipi di conferma o token diversi
          if (accessToken) {
            // Imposta la sessione se abbiamo un access token
            const { data, error } = await supabase.auth.setSession({
              access_token: accessToken,
              refresh_token: refreshToken
            })
          }
          
          statusDiv.innerHTML = `
            <h1>‚úÖ Account confermato!</h1>
            <p>Il tuo account √® stato confermato con successo.</p>
            <p>Ora puoi effettuare il login con le tue credenziali.</p>
            <button onclick="location.href='index.html'" class="btn-primary">ÔøΩ Vai al Login</button>
          `
          
          setTimeout(() => {
            window.location.href = 'index.html'
          }, 3000)
        } else {
          statusDiv.innerHTML = `
            <h1>‚ö†Ô∏è Link non valido</h1>
            <p>Il link di conferma non √® valido o √® scaduto.</p>
            <p>Se hai problemi, prova a registrarti nuovamente.</p>
            <button onclick="location.href='index.html'" class="btn-primary">üîô Torna al Login</button>
          `
        }
      } catch (error) {
        console.error('Errore imprevisto:', error)
        statusDiv.innerHTML = `
          <h1>‚ùå Errore</h1>
          <p>Si √® verificato un errore imprevisto.</p>
          <p class="error-detail">${error.message}</p>
          <button onclick="location.href='index.html'" class="btn-primary">üîô Torna al Login</button>
        `
      }
    }

    // Avvia la conferma quando la pagina √® caricata
    document.addEventListener('DOMContentLoaded', handleEmailConfirmation)
  </script>
</body>
</html>
