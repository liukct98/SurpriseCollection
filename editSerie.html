<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modifica Serie</title>
  <link rel="stylesheet" href="style.css?v=3.0&t=20250912">
</head>
<body>
  <header>Modifica Serie</header>
  <div class="container">
    <h1>‚úèÔ∏è Modifica Serie</h1>
    <form id="edit-serie-form">
  <label for="nome">Nome Serie</label>
  <input type="text" id="nome" required>

  <label for="anno">Anno</label>
  <input type="number" id="anno" min="1900" max="2099" required>

  <label for="nazione">Nazione</label>
  <input type="text" id="nazione" required>

  <label for="marca">Marca</label>
  <input type="text" id="marca">

  <label for="sottocategoria">Sottocategoria</label>
  <input type="text" id="sottocategoria">

  <label for="n_pezzi">Numero di pezzi totali</label>
  <input type="number" id="n_pezzi" min="1" required>

      <div class="form-buttons">
        <button type="submit" class="btn-primary">üíæ Salva Modifiche</button>
        <button type="button" class="btn-secondary" onclick="history.back()">üîô Annulla</button>
      </div>
    </form>
    
    <div id="edit-message"></div>
  </div>

  <nav class="bottom-nav">
    <a href="home.html" class="nav-item">
      <span class="icon">üè†</span>
      <span class="label">Home</span>
      <span class="ripple"></span>
    </a>
    <a href="collection.html" class="nav-item active">
      <span class="icon">üì¶</span>
      <span class="label">Collezione</span>
      <span class="ripple"></span>
    </a>
  </nav>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    // =============================
    // Inizializzazione Supabase
    // =============================
    const supabaseUrl = "https://ksypexyadycktzbfllfd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtzeXBleHlhZHlja3R6YmZsbGZkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MTYyMzEsImV4cCI6MjA3MjQ5MjIzMX0.INevNjooRZeLB--TM24JuIsq9EA47Zk3gBpIqjFyNGE";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    // Ottieni l'ID della serie dall'URL
    const urlParams = new URLSearchParams(window.location.search);
    const serieId = urlParams.get('id');

    if (!serieId) {
      alert('‚ùå ID serie non trovato');
      window.location.href = 'collection.html';
    }

    // =============================
    // CARICAMENTO DATI SERIE
    // =============================
    async function loadSerieData() {
      try {
        const { data: serie, error } = await supabase
          .from('series')
          .select('*')
          .eq('id', serieId)
          .single();

        if (error) {
          throw error;
        }

        if (!serie) {
          throw new Error('Serie non trovata');
        }

        // Popola il form con i dati della serie
  document.getElementById('nome').value = serie.nome || '';
  document.getElementById('anno').value = serie.anno || '';
  document.getElementById('nazione').value = serie.nazione || '';
  document.getElementById('marca').value = serie.marca || '';
  document.getElementById('sottocategoria').value = serie.sottocategoria || '';
  document.getElementById('n_pezzi').value = serie.n_pezzi || serie.n_oggetti || '';

      } catch (error) {
        alert('‚ùå Errore nel caricamento della serie: ' + error.message);
        window.location.href = 'collection.html';
      }
    }

    // =============================
    // GESTIONE MODIFICA SERIE
    // =============================
    document.getElementById('edit-serie-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const messageDiv = document.getElementById('edit-message');
      
      try {
        messageDiv.innerHTML = '‚è≥ Salvataggio modifiche...';
        messageDiv.className = 'loading';

        const formData = {
          nome: document.getElementById('nome').value.trim(),
          anno: parseInt(document.getElementById('anno').value),
          nazione: document.getElementById('nazione').value.trim(),
          marca: document.getElementById('marca').value.trim(),
          sottocategoria: document.getElementById('sottocategoria').value.trim(),
          n_pezzi: parseInt(document.getElementById('n_pezzi').value)
        };

        // Validazione
        if (!formData.nome || !formData.nazione) {
          throw new Error('Nome e nazione sono obbligatori');
        }

        if (formData.anno < 1900 || formData.anno > 2099) {
          throw new Error('Anno non valido');
        }

        if (formData.n_pezzi < 1) {
          throw new Error('Il numero di pezzi deve essere almeno 1');
        }

        // Aggiorna la serie nel database
        const { error } = await supabase
          .from('series')
          .update(formData)
          .eq('id', serieId);

        if (error) {
          throw error;
        }

        messageDiv.innerHTML = '‚úÖ Serie aggiornata con successo!';
        messageDiv.className = 'success';

        // Reindirizza alla collezione dopo 2 secondi
        setTimeout(() => {
          window.location.href = 'collection.html';
        }, 2000);

      } catch (error) {
        messageDiv.innerHTML = '‚ùå Errore: ' + error.message;
        messageDiv.className = 'error';
      }
    });

    // Carica i dati quando la pagina √® pronta
    window.addEventListener('load', loadSerieData);
  </script>
</body>
</html>
